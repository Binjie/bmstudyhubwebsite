<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
    <title>Spatial Memory Â· Grid Recall</title>
    <style>
        /* ===== GLOBAL CSS VARIABLES (matching site theme) ===== */
        :root {
            --primary: #E6E6FA;
            --primary-dark: #D8BFD8;
            --secondary: #FFD700;
            --secondary-dark: #FFC107;
            --accent: #6A5ACD;
            --accent-light: #9370DB;
            --background: #F9F9FF;
            --text: #333333;
            --text-light: #666666;
            --white: #FFFFFF;
            --gray: #F0F0F0;
            --gray-dark: #E0E0E0;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-light: rgba(0, 0, 0, 0.05);
            --success: #2ecc71;
            --error: #e74c3c;
        
            /* ç³»ç»Ÿå­—ä½“å †æ ˆï¼ˆæ— éœ€è”ç½‘ï¼‰ */
            --font-heading: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            --font-body: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        
            --border-radius: 12px;
            --border-radius-lg: 20px;
            --transition: all 0.3s ease;

            --grid-size: 4;  /* default 4x4 */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-body);
            font-size: 16px;
            line-height: 1.6;
            color: var(--text);
            background-color: var(--background);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .game-container {
            max-width: 780px;
            width: 100%;
            background: var(--white);
            border-radius: var(--border-radius-lg);
            box-shadow: 0 10px 25px var(--shadow);
            padding: 30px 25px;
            transition: var(--transition);
            border: 1px solid var(--gray);
        }

        .game-header {
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .game-title {
            font-family: var(--font-heading);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            margin-bottom: 5px;
        }

        .difficulty-badge {
            background: var(--primary-dark);
            padding: 5px 14px;
            border-radius: 30px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
            display: inline-block;
        }

        /* è®¾ç½®é¢æ¿ - ä¸ n-back é£æ ¼ç»Ÿä¸€ */
        .settings-panel {
            background: var(--gray);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
        }

        select, input[type="number"] {
            min-width: 130px;
            padding: 8px 12px;
            border: 2px solid var(--accent-light);
            border-radius: var(--border-radius);
            font-weight: 600;
            font-size: 1rem;
            background: var(--white);
            cursor: pointer;
            font-family: var(--font-body);
        }

        input[type="number"] {
            min-width: 80px;
        }

        /* ç½‘æ ¼åŒºåŸŸ */
        .grid-container {
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        #grid {
            display: grid;
            grid-template-columns: repeat(var(--grid-size), 1fr);
            gap: 12px;
            background: var(--gray);
            padding: 20px;
            border-radius: var(--border-radius);
            width: 100%;
            max-width: 450px;
        }

        .cell {
            aspect-ratio: 1 / 1;
            width: 100%;
            background: var(--white);
            border-radius: 10px;
            box-shadow: inset 0 2px 5px var(--shadow-light);
            transition: background 0.15s, transform 0.1s;
            cursor: pointer;
        }

        .cell.active {
            background: var(--accent) !important;
            box-shadow: 0 0 0 3px var(--secondary);
            transform: scale(0.92);
        }

        .cell.success {
            background: var(--success) !important;
        }

        .cell.error {
            background: var(--error) !important;
        }

        /* ç»Ÿè®¡é¢æ¿ */
        .stats {
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            background: var(--background);
            padding: 18px 20px;
            border-radius: var(--border-radius);
            margin-top: 20px;
            border: 1px solid var(--primary-dark);
        }

        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.7rem;
            font-weight: 700;
            color: var(--accent);
            line-height: 1.2;
        }

        .feedback {
            font-size: 1.2rem;
            font-weight: 600;
            padding: 8px 20px;
            border-radius: 40px;
            background: var(--white);
            border: 2px solid var(--secondary);
            text-align: center;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 12px 28px;
            border-radius: var(--border-radius);
            font-family: var(--font-heading);
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 1rem;
            background: var(--accent);
            color: var(--white);
            box-shadow: 0 4px 8px var(--shadow);
        }

        .btn:hover {
            background: var(--accent-light);
            transform: translateY(-3px);
            box-shadow: 0 8px 16px var(--shadow);
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--accent);
            color: var(--accent);
        }

        .btn-outline:hover {
            background: var(--accent);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .key-hint {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 15px;
            text-align: center;
            border-top: 1px dashed var(--gray-dark);
            padding-top: 15px;
        }

        .key {
            display: inline-block;
            background: var(--gray);
            border-radius: 6px;
            padding: 2px 10px;
            font-family: monospace;
            font-weight: 700;
            border: 1px solid var(--gray-dark);
        }

        /* å“åº”å¼ */
        @media (max-width: 600px) {
            .game-container { padding: 20px; }
            .settings-panel { flex-direction: column; align-items: stretch; }
            .control-group { flex-direction: column; align-items: flex-start; width: 100%; }
            select, input[type="number"] { width: 100%; min-width: unset; }
            .stat-value { font-size: 1.4rem; }
            #grid { gap: 8px; padding: 15px; }
        }

        @media (max-width: 400px) {
            #grid { gap: 5px; padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- å¤´éƒ¨ -->
        <div class="game-header">
            <h1 class="game-title">ğŸ§  Spatial Memory</h1>
            <span class="difficulty-badge" id="gridSizeBadge">4x4</span>
        </div>

        <!-- è®¾ç½®é¢æ¿ -->
        <div class="settings-panel">
            <div class="control-group">
                <label for="grid-select">Grid size:</label>
                <select id="grid-select">
                    <option value="3">3x3 (Beginner)</option>
                    <option value="4" selected>4x4 (Standard)</option>
                    <option value="5">5x5 (Advanced)</option>
                    <option value="6">6x6 (Master)</option>
                </select>
            </div>
            <div class="control-group">
                <label for="start-length">Start length:</label>
                <input type="number" id="start-length" value="3" min="2" max="8" step="1">
            </div>
            <button class="btn" id="startBtn">â–¶ Start</button>
            <button class="btn btn-outline" id="resetBtn">âŸ² Reset</button>
        </div>

        <!-- æ¸¸æˆç½‘æ ¼ -->
        <div class="grid-container">
            <div id="grid"></div>
        </div>

        <!-- ç»Ÿè®¡ä¸åé¦ˆ -->
        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Score</span>
                <span class="stat-value" id="scoreDisplay">0</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Best</span>
                <span class="stat-value" id="bestDisplay">3</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Current</span>
                <span class="stat-value" id="currentLenDisplay">3</span>
            </div>
            <div id="feedbackMessage" class="feedback" style="align-self: center;">Ready</div>
        </div>

        <!-- é”®ç›˜å¿«æ·é”®æç¤º -->
        <div class="key-hint">
            <span class="key">Space</span> Start / Pause Â· 
            <span class="key">R</span> Reset Â· 
            <span class="key">Click</span> cells to recall
        </div>
    </div>

    <script>
        (function() {
            "use strict";

            // ---------- DOM å…ƒç´  ----------
            const gridContainer = document.getElementById('grid');
            const gridSelect = document.getElementById('grid-select');
            const startLengthInput = document.getElementById('start-length');
            const startBtn = document.getElementById('startBtn');
            const resetBtn = document.getElementById('resetBtn');
            const scoreEl = document.getElementById('scoreDisplay');
            const bestEl = document.getElementById('bestDisplay');
            const currentLenEl = document.getElementById('currentLenDisplay');
            const feedbackEl = document.getElementById('feedbackMessage');
            const gridSizeBadge = document.getElementById('gridSizeBadge');

            // ---------- çŠ¶æ€å˜é‡ ----------
            let gridSize = 4;               // å½“å‰ç½‘æ ¼å¤§å°
            let sequence = [];             // å®Œæ•´çš„åºåˆ—ï¼ˆå•å…ƒæ ¼ç´¢å¼•ï¼‰
            let userSeq = [];             // ç”¨æˆ·å·²ç‚¹å‡»çš„åºåˆ—
            let isPlaying = false;        // æ¸¸æˆæ˜¯å¦è¿›è¡Œä¸­
            let isAnimating = false;      // æ˜¯å¦æ­£åœ¨æ’­æ”¾åŠ¨ç”»ï¼ˆç¦æ­¢ç‚¹å‡»ï¼‰
            let score = 0;               // æ­£ç¡®è½®æ¬¡æ•°ï¼ˆæ¯æ­£ç¡®ä¸€è½®+1ï¼‰
            let bestLength = 3;          // æœ€é•¿åºåˆ—é•¿åº¦ï¼ˆåˆå§‹ä¸ºèµ·å§‹é•¿åº¦ï¼‰
            let currentLength = 3;       // å½“å‰åºåˆ—é•¿åº¦ï¼ˆåŠ¨æ€å¢é•¿ï¼‰

            // ç½‘æ ¼å•å…ƒæ ¼å…ƒç´ ç¼“å­˜
            let cells = [];

            // ---------- è¾…åŠ©å‡½æ•° ----------
            function randomCellIndex() {
                return Math.floor(Math.random() * (gridSize * gridSize));
            }

            // ç”Ÿæˆæ–°åºåˆ—ï¼ˆä»…æ–°å¢ä¸€ä¸ªéšæœºç´¢å¼•ï¼‰
            function appendToSequence() {
                sequence.push(randomCellIndex());
            }

            // å®Œå…¨é‡ç½®åºåˆ—ï¼ˆæ ¹æ®å½“å‰èµ·å§‹é•¿åº¦ï¼‰
            function generateNewSequence() {
                sequence = [];
                for (let i = 0; i < currentLength; i++) {
                    sequence.push(randomCellIndex());
                }
            }

            // åˆå§‹åŒ–/é‡å»ºç½‘æ ¼ï¼ˆå½“gridSizeæ”¹å˜æ—¶è°ƒç”¨ï¼‰
            function buildGrid() {
                gridContainer.style.setProperty('--grid-size', gridSize);
                gridContainer.innerHTML = '';
                for (let i = 0; i < gridSize * gridSize; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    cell.dataset.index = i;
                    cell.addEventListener('click', onCellClick);
                    gridContainer.appendChild(cell);
                }
                // æ›´æ–°cellså¼•ç”¨
                cells = document.querySelectorAll('.cell');
            }

            // ---------- æ’­æ”¾åºåˆ—åŠ¨ç”» ----------
            async function playSequence() {
                isAnimating = true;
                feedbackEl.textContent = 'ğŸ‘€ Watch...';
                // ç¦ç”¨å¼€å§‹æŒ‰é’®ï¼ˆä½†ä¿ç•™é‡ç½®ï¼‰
                startBtn.disabled = true;

                for (let idx of sequence) {
                    if (!isPlaying) break; // è‹¥ä¸­é€”é‡ç½®/æš‚åœåˆ™åœæ­¢
                    await new Promise(r => setTimeout(r, 550));
                    if (!isPlaying) break;
                    cells[idx].classList.add('active');
                    await new Promise(r => setTimeout(r, 350));
                    if (!isPlaying) break;
                    cells[idx].classList.remove('active');
                }

                isAnimating = false;
                startBtn.disabled = false;
                if (isPlaying) {
                    feedbackEl.textContent = 'ğŸ” Your turn â€“ repeat the sequence';
                }
            }

            // ---------- å¼€å§‹æ–°å›åˆ ----------
            function startRound() {
                if (!isPlaying) return;
                // é‡ç½®ç”¨æˆ·è¾“å…¥
                userSeq = [];
                // æ’­æ”¾åºåˆ—åŠ¨ç”»
                playSequence();
            }

            // ---------- å¤„ç†å•å…ƒæ ¼ç‚¹å‡» ----------
            function onCellClick(e) {
                const idx = parseInt(e.currentTarget.dataset.index, 10);
                if (!isPlaying || isAnimating || userSeq.length >= sequence.length) return;

                // è®°å½•ç‚¹å‡»
                userSeq.push(idx);
                const currentStep = userSeq.length - 1;

                // å³æ—¶è§†è§‰åé¦ˆ
                const cell = e.currentTarget;
                if (idx === sequence[currentStep]) {
                    // æ­£ç¡®
                    cell.classList.add('success');
                    setTimeout(() => cell.classList.remove('success'), 200);
                    
                    // å¦‚æœå®Œæ•´è¾“å…¥äº†å…¨éƒ¨åºåˆ—
                    if (userSeq.length === sequence.length) {
                        // æ­£ç¡®ï¼åˆ†æ•°+1ï¼Œåºåˆ—é•¿åº¦+1ï¼Œç»§ç»­
                        score++;
                        scoreEl.textContent = score;

                        currentLength++;
                        currentLenEl.textContent = currentLength;
                        if (currentLength > bestLength) {
                            bestLength = currentLength;
                            bestEl.textContent = bestLength;
                        }

                        feedbackEl.textContent = 'âœ… Correct! Next level...';
                        // æ‰©å……åºåˆ—ï¼ˆå¢åŠ ä¸€ä¸ªæ–°éšæœºä½ç½®ï¼‰
                        appendToSequence();
                        // çŸ­æš‚å»¶è¿Ÿåå¼€å§‹ä¸‹ä¸€è½®åŠ¨ç”»
                        setTimeout(() => {
                            if (isPlaying) startRound();
                        }, 800);
                    }
                } else {
                    // é”™è¯¯ â€”â€” æ¸¸æˆç»“æŸ
                    cell.classList.add('error');
                    setTimeout(() => cell.classList.remove('error'), 200);
                    feedbackEl.textContent = `âŒ Wrong! You reached ${sequence.length} items.`;
                    gameOver();
                }
            }

            // ---------- æ¸¸æˆç»“æŸ ----------
            function gameOver() {
                isPlaying = false;
                startBtn.disabled = false;
                startBtn.textContent = 'â–¶ Start';
                isAnimating = false;
                // ä¿æŒbestä¸é‡ç½®
            }

            // ---------- é‡ç½®æ¸¸æˆï¼ˆä¿ç•™ç½‘æ ¼è®¾ç½®ï¼‰----------
            function resetGame(fullReset = true) {
                // å¼ºåˆ¶åœæ­¢æ‰€æœ‰æ´»åŠ¨
                isPlaying = false;
                isAnimating = false;
                startBtn.disabled = false;
                startBtn.textContent = 'â–¶ Start';

                // é‡ç½®çŠ¶æ€å˜é‡
                if (fullReset) {
                    // ä»è¾“å…¥æ¡†è¯»å–èµ·å§‹é•¿åº¦
                    currentLength = parseInt(startLengthInput.value, 10);
                    if (isNaN(currentLength) || currentLength < 2) currentLength = 3;
                    if (currentLength > 8) currentLength = 8; // ä¸Šé™8
                    score = 0;
                    // bestLength ä»…åœ¨è¶…è¿‡æ—¶æ›´æ–°ï¼Œé‡ç½®ä¸æ¸…é™¤ï¼Œä½†å¯ä»¥æ‰‹åŠ¨é‡ç½®ï¼Ÿä¸ºäº†ä½“éªŒï¼Œé‡ç½®æ—¶ä¸æ¸…é™¤æœ€é«˜è®°å½•ï¼Œä½†ä¿ç•™ã€‚
                    // ä½†å¦‚æœç”¨æˆ·åˆ‡æ¢ç½‘æ ¼ï¼Œåº”å½“é‡ç½®bestï¼Ÿ
                    // ç®€å•å¤„ç†ï¼šç‚¹å‡»resetæŒ‰é’®æ—¶ï¼Œä¸æ¸…é™¤bestï¼Œä½†é‡æ–°å¼€å§‹æ¸¸æˆã€‚
                }

                scoreEl.textContent = score;
                currentLenEl.textContent = currentLength;
                // bestä¿ç•™ä¹‹å‰çš„æœ€ä½³

                // æ¸…ç©ºåºåˆ—å¹¶é‡æ–°ç”Ÿæˆ
                sequence = [];
                for (let i = 0; i < currentLength; i++) {
                    sequence.push(randomCellIndex());
                }
                userSeq = [];

                // æ¸…é™¤æ‰€æœ‰é«˜äº®
                cells.forEach(cell => {
                    cell.classList.remove('active', 'success', 'error');
                });

                feedbackEl.textContent = 'Reset. Press Start to play.';
            }

            // ---------- å¼€å§‹ä¸»æ¸¸æˆ ----------
            function startGame() {
                if (isAnimating) return; // åŠ¨ç”»ä¸­ä¸èƒ½å¼€å§‹
                if (isPlaying) {
                    // æš‚åœåŠŸèƒ½ï¼ˆç®€å•å®ç°ï¼šåœæ­¢æ’­æ”¾ï¼Œä½†ä¿ç•™çŠ¶æ€ï¼‰
                    isPlaying = false;
                    startBtn.textContent = 'â–¶ Start';
                    feedbackEl.textContent = 'â¸ Paused';
                } else {
                    // å¼€å§‹æ–°æ¸¸æˆ
                    isPlaying = true;
                    startBtn.textContent = 'â¸ Pause';
                    // å¦‚æœåºåˆ—ä¸ºç©ºï¼Œå…ˆç”Ÿæˆ
                    if (sequence.length === 0) {
                        resetGame(true);
                    }
                    // å¼€å§‹å›åˆ
                    startRound();
                }
            }

            // ---------- åˆå§‹åŒ–äº‹ä»¶ç›‘å¬ ----------
            function init() {
                // åˆå§‹åŒ–ç½‘æ ¼
                gridSize = parseInt(gridSelect.value, 10);
                buildGrid();
                updateBadge();
                // åˆå§‹é‡ç½®
                resetGame(true);
                bestLength = currentLength;
                bestEl.textContent = bestLength;

                // ç›‘å¬ç½‘æ ¼å¤§å°å˜åŒ–
                gridSelect.addEventListener('change', function() {
                    gridSize = parseInt(gridSelect.value, 10);
                    buildGrid();
                    updateBadge();
                    // åˆ‡æ¢ç½‘æ ¼åï¼Œè‡ªåŠ¨é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼ˆåŒ…æ‹¬æœ€ä½³é•¿åº¦é‡ç½®ï¼Œå› ä¸ºç½‘æ ¼å˜åŒ–åéš¾åº¦ä¸åŒï¼‰
                    bestLength = parseInt(startLengthInput.value, 10);
                    bestEl.textContent = bestLength;
                    resetGame(true);
                });

                // èµ·å§‹é•¿åº¦è¾“å…¥æ¡†å˜åŒ–æ—¶ï¼Œé‡ç½®çŠ¶æ€ä½†ä¸è‡ªåŠ¨å¼€å§‹
                startLengthInput.addEventListener('change', function() {
                    let val = parseInt(startLengthInput.value, 10);
                    if (isNaN(val)) val = 3;
                    if (val < 2) val = 2;
                    if (val > 8) val = 8;
                    startLengthInput.value = val;
                    if (!isPlaying) {
                        currentLength = val;
                        resetGame(true);
                    }
                });

                // æŒ‰é’®äº‹ä»¶
                startBtn.addEventListener('click', startGame);
                resetBtn.addEventListener('click', function() {
                    // é‡ç½®æ—¶ä¸æ¸…é™¤æœ€ä½³è®°å½•ï¼ˆä½†è‹¥ç½‘æ ¼å·²å˜ï¼Œä¸Šé¢å·²é‡ç½®bestï¼‰
                    // è¿™é‡Œä»…é‡ç½®æ¸¸æˆçŠ¶æ€
                    if (!isPlaying) {
                        resetGame(true);
                    } else {
                        // å¼ºåˆ¶ç»“æŸ
                        isPlaying = false;
                        resetGame(true);
                    }
                });

                // é”®ç›˜å¿«æ·é”®
                window.addEventListener('keydown', function(e) {
                    if (e.code === 'Space' || e.key === ' ') {
                        e.preventDefault();
                        startGame();
                    }
                    if (e.key === 'r' || e.key === 'R') {
                        e.preventDefault();
                        resetBtn.click();
                    }
                });
            }

            function updateBadge() {
                gridSizeBadge.textContent = `${gridSize}x${gridSize}`;
            }

            init();
        })();
    </script>
</body>
</html>