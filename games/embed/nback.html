<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes"
    />
    <title>Dual N‚ÄëBack ¬∑ Cognitive Training (with Audio)</title>
    <style>
      /* ===== INJECTED GLOBAL CSS VARIABLES ===== */
      :root {
        --primary: #e6e6fa;
        --primary-dark: #d8bfd8;
        --secondary: #ffd700;
        --secondary-dark: #ffc107;
        --accent: #6a5acd;
        --accent-light: #9370db;
        --background: #f9f9ff;
        --text: #333333;
        --text-light: #666666;
        --white: #ffffff;
        --gray: #f0f0f0;
        --gray-dark: #e0e0e0;
        --shadow: rgba(0, 0, 0, 0.1);
        --shadow-light: rgba(0, 0, 0, 0.05);

        --font-heading:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol";
        --font-body:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji",
          "Segoe UI Emoji", "Segoe UI Symbol";

        --border-radius: 12px;
        --border-radius-lg: 20px;
        --transition: all 0.3s ease;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-body);
        font-size: 16px;
        line-height: 1.6;
        color: var(--text);
        background-color: var(--background);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .game-container {
        max-width: 780px;
        width: 100%;
        background: var(--white);
        border-radius: var(--border-radius-lg);
        box-shadow: 0 10px 25px var(--shadow);
        padding: 30px 25px;
        transition: var(--transition);
        border: 1px solid var(--gray);
      }

      .game-header {
        display: flex;
        flex-wrap: wrap;
        align-items: baseline;
        justify-content: space-between;
        margin-bottom: 25px;
      }

      .game-title {
        font-family: var(--font-heading);
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--accent);
        margin-bottom: 5px;
      }

      .n-badge {
        background: var(--primary-dark);
        padding: 5px 14px;
        border-radius: 30px;
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--accent);
        display: inline-block;
      }

      /* settings panel */
      .settings-panel {
        background: var(--gray);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 25px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 20px;
      }

      .n-level {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .n-level label {
        font-weight: 600;
        color: var(--text);
        white-space: nowrap;
      }

      /* ===== ÊîπËøõÔºöÊãâÈïøÈÄâÊã©Ê°ÜÔºå‰øùÊåÅÊñáÂ≠óÂ§ßÂ∞è ===== */
      #nValue {
        min-width: 150px; /* Ë∂≥Â§üÂÆΩÔºåÈÅøÂÖçÈÅÆÊå° */
        width: auto; /* Ëá™Âä®ÈÄÇÂ∫îÂÜÖÂÆπ */
        padding: 8px 12px;
        border: 2px solid var(--accent-light);
        border-radius: var(--border-radius);
        font-weight: 600;
        font-size: 1rem; /* ‰øùÊåÅÂéüÂ≠ó‰ΩìÂ§ßÂ∞èÔºå‰∏çÁº©Â∞è */
        background: var(--white);
        cursor: pointer;
      }

      /* ÁßªÂä®ËÆæÂ§á‰∏äÂÆΩÂ∫¶Âç†Êª°Ôºå‰æùÁÑ∂‰∏çÁº©Â∞èÊñáÂ≠ó */
      @media (max-width: 600px) {
        #nValue {
          min-width: 100%;
          width: 100%;
        }
      }

      /* grid 3x3 */
      .grid-3x3 {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
        background: var(--gray);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        aspect-ratio: 1 / 1;
        max-width: 300px;
        margin-left: auto;
        margin-right: auto;
      }

      .grid-cell {
        background: var(--white);
        border-radius: 10px;
        aspect-ratio: 1 / 1;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 2px 5px var(--shadow-light);
        transition: background 0.15s;
      }

      .grid-cell.active {
        background: var(--accent);
        box-shadow: 0 0 0 3px var(--secondary);
      }

      .letter-display {
        text-align: center;
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent);
        background: var(--primary);
        padding: 15px;
        border-radius: var(--border-radius);
        margin: 10px 0 20px;
        letter-spacing: 4px;
      }

      .stats {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        background: var(--background);
        padding: 18px 20px;
        border-radius: var(--border-radius);
        margin-top: 20px;
        border: 1px solid var(--primary-dark);
      }

      .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .stat-label {
        font-size: 0.85rem;
        color: var(--text-light);
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-value {
        font-size: 1.7rem;
        font-weight: 700;
        color: var(--accent);
        line-height: 1.2;
      }

      .feedback {
        font-size: 1.2rem;
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 40px;
        background: var(--white);
        border: 2px solid var(--secondary);
      }

      .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
        margin-top: 25px;
      }

      .btn {
        padding: 12px 28px;
        border-radius: var(--border-radius);
        font-family: var(--font-heading);
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        border: none;
        font-size: 1rem;
        background: var(--accent);
        color: var(--white);
        box-shadow: 0 4px 8px var(--shadow);
      }

      .btn:hover {
        background: var(--accent-light);
        transform: translateY(-3px);
        box-shadow: 0 8px 16px var(--shadow);
      }

      .btn-secondary {
        background: var(--secondary);
        color: var(--text);
      }

      .btn-secondary:hover {
        background: var(--secondary-dark);
      }

      .btn-outline {
        background: transparent;
        border: 2px solid var(--accent);
        color: var(--accent);
      }

      .btn-outline:hover {
        background: var(--accent);
        color: white;
      }

      .key-hint {
        font-size: 0.85rem;
        color: var(--text-light);
        margin-top: 10px;
        text-align: center;
        border-top: 1px dashed var(--gray-dark);
        padding-top: 15px;
      }

      .key {
        display: inline-block;
        background: var(--gray);
        border-radius: 6px;
        padding: 2px 10px;
        font-family: monospace;
        font-weight: 700;
        border: 1px solid var(--gray-dark);
      }

      @media (max-width: 600px) {
        .game-container {
          padding: 20px;
        }
        .settings-panel {
          flex-direction: column;
          align-items: stretch;
        }
        .grid-3x3 {
          max-width: 250px;
        }
        .stat-value {
          font-size: 1.4rem;
        }
        .n-level label {
          white-space: normal;
        }
      }
    </style>
  </head>
  <body>
    <div class="game-container">
      <div class="game-header">
        <h1 class="game-title">üéØ Dual N‚ÄëBack</h1>
        <span class="n-badge" id="currentNLabel">2‚Äëback</span>
      </div>

      <div class="settings-panel">
        <div class="n-level">
          <label for="nValue">N‚Äëback level:</label>
          <select id="nValue" aria-label="N-back level">
            <option value="1">1-back</option>
            <option value="2" selected>2-back</option>
            <option value="3">3-back</option>
            <option value="4">4-back</option>
            <option value="5">5-back</option>
          </select>
        </div>
        <button class="btn" id="startBtn">‚ñ∂ Start Game</button>
        <button class="btn btn-outline" id="resetBtn">‚ü≤ Reset</button>
      </div>

      <div class="grid-3x3" id="positionGrid"></div>
      <div class="letter-display" id="letterDisplay">‚Äî</div>

      <div class="stats">
        <div class="stat-item">
          <span class="stat-label">Trials</span>
          <span class="stat-value" id="trialCount">0</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Accuracy</span>
          <span class="stat-value" id="accuracyDisplay">0%</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Score</span>
          <span class="stat-value" id="scoreDisplay">0</span>
        </div>
        <div id="feedbackMessage" class="feedback" style="align-self: center">
          Ready
        </div>
      </div>

      <div class="button-group">
        <button class="btn btn-secondary" id="posMatchBtn">
          üìç Position match (A)
        </button>
        <button class="btn btn-secondary" id="letterMatchBtn">
          üî§ Letter match (L)
        </button>
        <button class="btn btn-secondary" id="bothMatchBtn">
          ‚ú® Both match (Space)
        </button>
      </div>

      <div class="key-hint">
        <span class="key">A</span> position match ¬∑
        <span class="key">L</span> letter match ¬∑
        <span class="key">Space</span> both match ¬∑
        <span class="key">S</span> start/stop
      </div>
    </div>

    <script>
      (function () {
        "use strict";

        // --- DOM elements ---
        const gridContainer = document.getElementById("positionGrid");
        const letterEl = document.getElementById("letterDisplay");
        const nSelect = document.getElementById("nValue");
        const currentNLabel = document.getElementById("currentNLabel");
        const startBtn = document.getElementById("startBtn");
        const resetBtn = document.getElementById("resetBtn");
        const posBtn = document.getElementById("posMatchBtn");
        const letterBtn = document.getElementById("letterMatchBtn");
        const bothBtn = document.getElementById("bothMatchBtn");
        const trialEl = document.getElementById("trialCount");
        const accuracyEl = document.getElementById("accuracyDisplay");
        const scoreEl = document.getElementById("scoreDisplay");
        const feedbackEl = document.getElementById("feedbackMessage");

        // --- Game state ---
        let isRunning = false;
        let n = 2;
        let trialCounter = 0;
        let correctHits = 0;
        let totalResponses = 0;

        let posHistory = [];
        let letterHistory = [];

        let currentPos = 0;
        let currentLetter = "A";

        let intervalId = null;
        const STIMULUS_INTERVAL = 3000; // 3 seconds

        const LETTERS = ["A", "B", "C", "D", "E", "F", "G", "H"];

        // --- ËØ≠Èü≥ÂêàÊàêÂáΩÊï∞ÔºàÊñ∞Â¢ûÔºâ---
        function speakLetter(letter) {
          if ("speechSynthesis" in window) {
            // ÂèñÊ∂àÂΩìÂâçÊ≠£Âú®ÊúóËØªÁöÑËØ≠Èü≥ÔºåÈÅøÂÖçÈáçÂè†
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(letter);
            utterance.rate = 0.9; // Áï•ÊÖ¢ÔºåÊõ¥Ê∏ÖÊô∞
            utterance.pitch = 1;
            utterance.volume = 1;
            utterance.lang = "en-US";
            window.speechSynthesis.speak(utterance);
          } else {
            // ÊµèËßàÂô®‰∏çÊîØÊåÅËØ≠Èü≥ÔºåÈùôÈªòÂ§±Ë¥•Ôºà‰∏çÂΩ±ÂìçÊ∏∏ÊàèÔºâ
            console.log("Speech synthesis not supported");
          }
        }

        // --- Helper functions ---
        function randomPosition() {
          return Math.floor(Math.random() * 9);
        }

        function randomLetter() {
          return LETTERS[Math.floor(Math.random() * LETTERS.length)];
        }

        function renderGrid(pos) {
          const cells = document.querySelectorAll(".grid-cell");
          cells.forEach((cell, idx) => {
            if (idx === pos) {
              cell.classList.add("active");
            } else {
              cell.classList.remove("active");
            }
          });
        }

        function buildGrid() {
          gridContainer.innerHTML = "";
          for (let i = 0; i < 9; i++) {
            const cell = document.createElement("div");
            cell.className = "grid-cell";
            gridContainer.appendChild(cell);
          }
        }

        // --- Core game logic: produce a new trial ---
        function nextTrial() {
          if (!isRunning) return;

          const newPos = randomPosition();
          const newLetter = randomLetter();

          currentPos = newPos;
          currentLetter = newLetter;

          renderGrid(newPos);
          letterEl.textContent = newLetter;

          // ‚òÖ ÊúóËØªÂ≠óÊØçÔºàÂê¨ËßâÂà∫ÊøÄÔºâ
          speakLetter(newLetter);

          posHistory.push(newPos);
          letterHistory.push(newLetter);

          trialCounter++;
          trialEl.textContent = trialCounter;
        }

        // --- Process response ---
        function handleResponse(type) {
          if (!isRunning) {
            feedbackEl.textContent = "‚è∏ Game not started";
            return;
          }
          if (trialCounter <= n) {
            feedbackEl.textContent = "‚è≥ Wait, history building...";
            return;
          }

          n = parseInt(nSelect.value, 10);
          currentNLabel.textContent = n + "-back";

          const idxCurrent = posHistory.length - 1;
          const idxPrev = idxCurrent - n;

          if (idxPrev < 0) {
            feedbackEl.textContent = "‚è≥ Still building history...";
            return;
          }

          const prevPos = posHistory[idxPrev];
          const prevLetter = letterHistory[idxPrev];
          const currPos = posHistory[idxCurrent];
          const currLetter = letterHistory[idxCurrent];

          const posMatch = currPos === prevPos;
          const letterMatch = currLetter === prevLetter;

          let isCorrect = false;
          let feedbackMsg = "";

          if (posMatch && letterMatch) {
            if (type === "both") {
              isCorrect = true;
              feedbackMsg = "‚úÖ Both correct!";
            } else {
              feedbackMsg = "‚ùå Miss: both matched!";
            }
          } else if (posMatch) {
            if (type === "pos") {
              isCorrect = true;
              feedbackMsg = "‚úÖ Position match!";
            } else {
              feedbackMsg = "‚ùå Position matched!";
            }
          } else if (letterMatch) {
            if (type === "letter") {
              isCorrect = true;
              feedbackMsg = "‚úÖ Letter match!";
            } else {
              feedbackMsg = "‚ùå Letter matched!";
            }
          } else {
            isCorrect = false;
            feedbackMsg = "‚ùå False alarm (no match)";
          }

          totalResponses++;
          if (isCorrect) {
            correctHits++;
            feedbackEl.textContent = feedbackMsg;
          } else {
            feedbackEl.textContent = feedbackMsg;
          }

          scoreEl.textContent = correctHits;
          const accuracy =
            totalResponses > 0
              ? Math.round((correctHits / totalResponses) * 100)
              : 0;
          accuracyEl.textContent = accuracy + "%";
        }

        // --- Reset game ---
        function resetGame() {
          if (isRunning) {
            stopGame();
          }
          isRunning = false;
          startBtn.textContent = "‚ñ∂ Start Game";
          trialCounter = 0;
          correctHits = 0;
          totalResponses = 0;
          posHistory = [];
          letterHistory = [];
          trialEl.textContent = "0";
          scoreEl.textContent = "0";
          accuracyEl.textContent = "0%";
          feedbackEl.textContent = "Reset";
          letterEl.textContent = "‚Äî";
          const cells = document.querySelectorAll(".grid-cell");
          cells.forEach((c) => c.classList.remove("active"));
          n = parseInt(nSelect.value, 10);
          currentNLabel.textContent = n + "-back";

          // ÂÅúÊ≠¢‰ªª‰ΩïÊ≠£Âú®ÊúóËØªÁöÑËØ≠Èü≥
          if ("speechSynthesis" in window) {
            window.speechSynthesis.cancel();
          }
        }

        function stopGame() {
          if (intervalId) {
            clearInterval(intervalId);
            intervalId = null;
          }
          isRunning = false;
          startBtn.textContent = "‚ñ∂ Start Game";
          feedbackEl.textContent = "Paused";

          // ÊöÇÂÅúÊó∂‰πüÂÅúÊ≠¢ËØ≠Èü≥
          if ("speechSynthesis" in window) {
            window.speechSynthesis.cancel();
          }
        }

        function startGame() {
          if (isRunning) {
            stopGame();
          } else {
            if (trialCounter === 0) {
              posHistory = [];
              letterHistory = [];
            }
            isRunning = true;
            startBtn.textContent = "‚è∏ Pause";
            n = parseInt(nSelect.value, 10);
            currentNLabel.textContent = n + "-back";
            if (trialCounter === 0) {
              nextTrial(); // first stimulus
            }
            if (intervalId) clearInterval(intervalId);
            intervalId = setInterval(() => {
              nextTrial();
            }, STIMULUS_INTERVAL);
            feedbackEl.textContent = "üéß Listening...";
          }
        }

        // --- Event listeners ---
        function init() {
          buildGrid();
          resetGame();

          startBtn.addEventListener("click", startGame);

          resetBtn.addEventListener("click", function () {
            resetGame();
          });

          posBtn.addEventListener("click", () => handleResponse("pos"));
          letterBtn.addEventListener("click", () => handleResponse("letter"));
          bothBtn.addEventListener("click", () => handleResponse("both"));

          window.addEventListener("keydown", (e) => {
            if (e.code === "Space" || e.key === " ") {
              e.preventDefault();
              if (isRunning) handleResponse("both");
            }
            if (e.key === "a" || e.key === "A") {
              if (isRunning) handleResponse("pos");
            }
            if (e.key === "l" || e.key === "L") {
              if (isRunning) handleResponse("letter");
            }
            if (e.key === "s" || e.key === "S") {
              startGame();
            }
            if (e.key === "r" || e.key === "R") {
              resetGame();
            }
          });

          nSelect.addEventListener("change", function () {
            const newN = parseInt(nSelect.value, 10);
            currentNLabel.textContent = newN + "-back";
          });
        }

        init();
      })();
    </script>
  </body>
</html>
